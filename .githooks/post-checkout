#!/bin/bash
# Post-checkout hook: Re-index code after switching branches

# Get the project directory (works for both regular repos and submodules)
PROJECT_DIR="$(git rev-parse --show-toplevel)"
GIT_DIR="$(git rev-parse --git-dir)"

BINARY="$HOME/.swiftpm/bin/code-search-mcp"
LOCK_FILE="$GIT_DIR/code-search-mcp.lock"
LOG_FILE="$GIT_DIR/code-search-mcp.log"

# $3 is 1 if it's a branch checkout, 0 if it's a file checkout
if [ "$3" = "1" ]; then
  # Check if another index job is running
  if [ -f "$LOCK_FILE" ]; then
    # Check if the process is still running (stale lock detection)
    if kill -0 "$(cat "$LOCK_FILE")" 2>/dev/null; then
      echo "‚è≥ [post-checkout] Index already in progress, skipping..."
      exit 0
    else
      # Stale lock file - remove it
      rm -f "$LOCK_FILE"
    fi
  fi

  if [ -x "$BINARY" ]; then
    echo "üìö [post-checkout] Re-indexing after branch switch..."
    (
      echo $$ > "$LOCK_FILE"
      "$BINARY" index "$PROJECT_DIR" >> "$LOG_FILE" 2>&1
      rm -f "$LOCK_FILE"
    ) &
  else
    echo "‚ö†Ô∏è  code-search-mcp not found at $BINARY"
    echo "    Run: ./scripts/setup-code-search.sh"
  fi
fi
